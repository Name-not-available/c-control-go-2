<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FCEDA5">
    <link rel="manifest" href="/manifest.json">
    <title>Savor Delicious Flavors of the Food Boulevard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Schematic placeholder style */
        .schematic-img {
            background-color: #e5e7eb;
            background-image: linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6), 
                              linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
        }

        .restaurant-box {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .restaurant-box:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex justify-center items-start">

    <!-- Main Container representing the board -->
    <div class="bg-white w-full max-w-[1400px] shadow-2xl overflow-hidden rounded-lg flex flex-col">
        
        <!-- Header -->
        <header class="bg-gray-100 p-6 border-b border-gray-300 flex justify-between items-center">
            <h1 class="text-2xl md:text-4xl font-extrabold text-gray-800 uppercase tracking-tight">
                Savor Delicious Flavors of the Food Boulevard
            </h1>
            <div class="hidden md:flex flex-col items-end text-sm text-gray-600">
                <span class="font-bold">READY TO EAT?</span>
                <span>SCAN AND GO!</span>
                <div class="w-12 h-12 bg-black mt-1"></div> <!-- QR Code Placeholder -->
            </div>
        </header>

        <!-- Search Section -->
        <div class="bg-white p-4 border-b border-gray-300">
            <div class="flex flex-col md:flex-row gap-3">
                <input 
                    type="number" 
                    id="latitude" 
                    placeholder="Latitude (e.g., 40.7128)" 
                    step="any"
                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                >
                <input 
                    type="number" 
                    id="longitude" 
                    placeholder="Longitude (e.g., -74.0060)" 
                    step="any"
                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                >
                <button 
                    id="search-btn"
                    onclick="searchRestaurants()" 
                    class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors"
                >
                    üîç Search
                </button>
                <button 
                    id="location-btn"
                    onclick="getCurrentLocation()" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
                >
                    üìç My Location
                </button>
            </div>
            <div id="error" class="hidden mt-3 bg-red-50 border-l-4 border-red-500 text-red-700 p-3 rounded"></div>
            <div id="loading" class="hidden mt-3 text-center">
                <div class="inline-block">
                    <div class="loading-spinner w-8 h-8 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Searching for restaurants...</p>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex flex-col h-full">
            
            <!-- MAIN COLUMN (Yellow) -->
            <div class="w-full bg-[#FCEDA5] flex flex-col relative" id="left-column">
                
                <!-- Floor 3 -->
                <div class="flex p-4" id="floor-3-left">
                    <div class="flex-1 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" id="floor-3-left-grid">
                        <!-- Restaurants will be populated here -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Floor grid configuration - only floor-3-left
        const floorGrids = [
            { id: 'floor-3-left-grid', cols: 6, isBlue: false }
        ];

        // Track request states to prevent multiple concurrent requests
        let isLocationRequestInProgress = false;
        let isSearchInProgress = false;
        let locationPermissionStatus = null; // 'granted', 'denied', 'prompt', or null

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            // Disable/enable buttons during loading
            const locationBtn = document.getElementById('location-btn');
            const searchBtn = document.getElementById('search-btn');
            
            [locationBtn, searchBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = show;
                    btn.style.opacity = show ? '0.6' : '1';
                    btn.style.cursor = show ? 'not-allowed' : 'pointer';
                }
            });
        }

        // Check and update permission status
        async function checkLocationPermission() {
            if (!navigator.permissions) {
                // Permissions API not supported, return unknown
                return null;
            }
            try {
                const result = await navigator.permissions.query({ name: 'geolocation' });
                locationPermissionStatus = result.state;
                
                // Listen for permission changes
                result.onchange = () => {
                    locationPermissionStatus = result.state;
                    updateLocationButtonState();
                };
                
                return result.state;
            } catch (e) {
                console.warn('Permission query failed:', e);
                return null;
            }
        }

        // Update button appearance based on permission state
        function updateLocationButtonState() {
            const locationBtn = document.getElementById('location-btn');
            if (!locationBtn) return;
            
            if (locationPermissionStatus === 'granted') {
                locationBtn.textContent = 'üìç My Location';
                locationBtn.title = 'Location access granted - click to get your position';
            } else if (locationPermissionStatus === 'denied') {
                locationBtn.textContent = 'üö´ Location Blocked';
                locationBtn.title = 'Location access denied - please enable it in browser settings';
            } else {
                locationBtn.textContent = 'üìç My Location';
                locationBtn.title = 'Click to request location access';
            }
        }

        // Get specific error message based on error code
        function getLocationErrorMessage(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    return 'üö´ Location access denied. Please enable location permissions in your browser settings and try again.';
                case error.POSITION_UNAVAILABLE:
                    return 'üì° Location unavailable. Your device could not determine your position. Please try again or enter coordinates manually.';
                case error.TIMEOUT:
                    return '‚è±Ô∏è Location request timed out. Please check your GPS/location settings and try again.';
                default:
                    return '‚ùå Unable to get your location: ' + error.message;
            }
        }

        async function getCurrentLocation() {
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser. Please enter coordinates manually.');
                return;
            }

            // Prevent multiple concurrent requests (debouncing)
            if (isLocationRequestInProgress) {
                console.log('Location request already in progress, ignoring duplicate request');
                return;
            }

            // Check permission status first
            const permissionState = await checkLocationPermission();
            
            // If permission was explicitly denied, show helpful message
            if (permissionState === 'denied') {
                showError('üö´ Location access is blocked. To enable it:\n‚Ä¢ Click the lock/info icon in your browser\'s address bar\n‚Ä¢ Find "Location" and set it to "Allow"\n‚Ä¢ Then refresh the page and try again');
                return;
            }

            // Set request in progress flag
            isLocationRequestInProgress = true;
            showLoading(true);

            // Geolocation options for better reliability
            const options = {
                enableHighAccuracy: true,  // Request high accuracy (GPS)
                timeout: 15000,            // 15 second timeout
                maximumAge: 60000          // Accept cached position up to 1 minute old
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Success callback
                    isLocationRequestInProgress = false;
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                    showLoading(false);
                    
                    // Update permission status
                    locationPermissionStatus = 'granted';
                    updateLocationButtonState();
                    
                    // Automatically search
                    searchRestaurants();
                },
                (error) => {
                    // Error callback
                    isLocationRequestInProgress = false;
                    showLoading(false);
                    
                    // Update permission status if denied
                    if (error.code === error.PERMISSION_DENIED) {
                        locationPermissionStatus = 'denied';
                        updateLocationButtonState();
                    }
                    
                    showError(getLocationErrorMessage(error));
                },
                options
            );
        }

        // Initialize permission check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkLocationPermission();
            updateLocationButtonState();
        });

        function formatDistance(distanceKm) {
            if (distanceKm < 1.0) {
                return Math.round(distanceKm * 1000) + 'm';
            }
            return distanceKm.toFixed(2) + 'km';
        }

        function getRestaurantImageUrl(restaurant) {
            // If photo reference is available from Google Places API, use it
            if (restaurant.PhotoReference) {
                return `/api/photo?photo_reference=${encodeURIComponent(restaurant.PhotoReference)}`;
            }
            
            // Fallback: Try to get a food-related image from Unsplash Source
            const hash = restaurant.Name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const foodKeywords = ['restaurant', 'food', 'dining', 'cuisine', 'meal', 'dish', 'cooking'];
            const keyword = foodKeywords[hash % foodKeywords.length];
            // Use Unsplash Source with a unique identifier based on restaurant name
            return `https://source.unsplash.com/400x300/?${keyword}&sig=${hash}`;
        }

        function getRestaurantBackgroundColor(restaurant) {
            // Generate a color gradient based on restaurant name as fallback
            const hash = restaurant.Name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const hue1 = hash % 360;
            const hue2 = (hash + 60) % 360;
            return `linear-gradient(135deg, hsl(${hue1}, 70%, 50%) 0%, hsl(${hue2}, 70%, 50%) 100%)`;
        }

        function formatPriceLevel(priceLevel) {
            if (priceLevel === undefined || priceLevel === null) {
                return '';
            }
            switch (priceLevel) {
                case 0:
                    return 'Average bill: Free';
                case 1:
                    return 'Average bill: $ (Inexpensive)';
                case 2:
                    return 'Average bill: $$ (Moderate)';
                case 3:
                    return 'Average bill: $$$ (Expensive)';
                case 4:
                    return 'Average bill: $$$$ (Very Expensive)';
                default:
                    return '';
            }
        }

        function getPriceSymbol(priceLevel) {
            if (priceLevel === undefined || priceLevel === null) {
                return '';
            }
            switch (priceLevel) {
                case 0:
                    return 'Free';
                case 1:
                    return '$';
                case 2:
                    return '$$';
                case 3:
                    return '$$$';
                case 4:
                    return '$$$$';
                default:
                    return '';
            }
        }

        function createRestaurantBox(restaurant, index, isBlue = false, isRed = false) {
            const box = document.createElement('div');
            // Make cards bigger - taller aspect ratio
            box.className = 'restaurant-box flex flex-col gap-2 w-full aspect-[3/4] md:aspect-[4/3]';
            
            // Use place_id if available (opens actual restaurant page), otherwise use coordinates
            let mapsURL;
            if (restaurant.PlaceID) {
                // Use query+query_place_id to open the Google Place card directly
                const nameParam = encodeURIComponent(restaurant.Name || 'GooglePlace');
                mapsURL = `https://www.google.com/maps/search/?api=1&query=${nameParam}&query_place_id=${restaurant.PlaceID}`;
            } else {
                const searchQuery = encodeURIComponent(`${restaurant.Name || 'Restaurant'} ${restaurant.Latitude},${restaurant.Longitude}`);
                mapsURL = `https://www.google.com/maps/search/?api=1&query=${searchQuery}`;
            }
            
            // Add image - make it bigger
            const imgContainer = document.createElement('div');
            const bgGradient = getRestaurantBackgroundColor(restaurant);
            imgContainer.className = 'w-full h-[75%] md:h-[70%] rounded-sm border border-black/5 relative overflow-hidden';
            imgContainer.style.background = bgGradient;
            imgContainer.style.backgroundSize = 'cover';
            imgContainer.style.backgroundPosition = 'center';
            
            const img = document.createElement('img');
            img.src = getRestaurantImageUrl(restaurant);
            img.className = 'w-full h-full object-cover absolute top-0 left-0';
            img.alt = restaurant.Name;
            img.onerror = function() {
                // If image fails to load, hide it and show the gradient background
                this.style.display = 'none';
            };
            img.onload = function() {
                // Image loaded successfully, overlay the gradient
                this.style.display = 'block';
            };
            imgContainer.appendChild(img);
            
            // Add rating badge if available (same size as price badge)
            if (restaurant.Rating > 0) {
                const ratingBadge = document.createElement('div');
                ratingBadge.className = 'absolute top-2 left-2 bg-black/50 text-white text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                let ratingText = `‚≠ê${restaurant.Rating.toFixed(1)}`;
                if (restaurant.ReviewCount && restaurant.ReviewCount > 0) {
                    ratingText += `(${restaurant.ReviewCount})`;
                }
                ratingBadge.textContent = ratingText;
                imgContainer.appendChild(ratingBadge);
            }

            const priceSymbol = getPriceSymbol(restaurant.PriceLevel);
            if (priceSymbol) {
                const priceBadge = document.createElement('div');
                priceBadge.className = 'absolute top-2 right-2 bg-black/50 text-green-300 text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                priceBadge.textContent = priceSymbol;
                const priceDescription = formatPriceLevel(restaurant.PriceLevel);
                if (priceDescription) {
                    priceBadge.title = priceDescription;
                }
                imgContainer.appendChild(priceBadge);
            }
            
            box.appendChild(imgContainer);

            // Add text label - full name on mobile, truncated on desktop
            const textLabel = document.createElement('div');
            textLabel.textContent = restaurant.Name;
            textLabel.className = 'text-sm md:text-[9px] font-bold leading-tight text-center px-1 md:truncate';
            
            if (isRed) {
                textLabel.classList.add('text-red-600');
            } else if (isBlue) {
                textLabel.classList.add('text-white');
            } else {
                textLabel.classList.add('text-gray-800');
            }
            
            box.appendChild(textLabel);

            if (restaurant.Type) {
                const typeBadge = document.createElement('div');
                typeBadge.textContent = restaurant.Type;
                typeBadge.className = 'absolute bottom-2 left-2 bg-white/70 text-gray-700 text-[10px] md:text-[8px] px-2 py-0.5 rounded';
                imgContainer.appendChild(typeBadge);
            }

            const distanceLabel = document.createElement('div');
            distanceLabel.textContent = formatDistance(restaurant.Distance);
            distanceLabel.className = 'absolute bottom-2 right-2 bg-black/50 text-white text-[10px] md:text-[8px] px-2 py-0.5 rounded';
            imgContainer.appendChild(distanceLabel);

            // Add click handler to open maps
            box.onclick = () => window.open(mapsURL, '_blank');
            box.title = `${restaurant.Name}\n${restaurant.Address || 'No address'}\nDistance: ${formatDistance(restaurant.Distance)}`;

            return box;
        }

        function clearAllGrids() {
            const element = document.getElementById('floor-3-left-grid');
            if (element) {
                element.innerHTML = '';
            }
        }

        function populateGrids(restaurants) {
            clearAllGrids();
            
            // Put all restaurants in floor-3-left-grid
            const element = document.getElementById('floor-3-left-grid');
            if (!element) return;
            
            restaurants.forEach((restaurant, index) => {
                const box = createRestaurantBox(
                    restaurant, 
                    index, 
                    false, // isBlue
                    false  // isRed
                );
                element.appendChild(box);
            });
        }

        function searchRestaurants() {
            // Prevent multiple concurrent search requests
            if (isSearchInProgress) {
                console.log('Search already in progress, ignoring duplicate request');
                return;
            }

            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);

            if (isNaN(lat) || isNaN(lon)) {
                showError('Please enter valid latitude and longitude values');
                return;
            }

            isSearchInProgress = true;
            showLoading(true);
            clearAllGrids();

            fetch(`/api/restaurants?lat=${lat}&lon=${lon}`)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Failed to fetch restaurants');
                        });
                    }
                    return response.json();
                })
                .then(restaurants => {
                    isSearchInProgress = false;
                    showLoading(false);
                    if (restaurants.length === 0) {
                        showError('No restaurants found. Try a different location.');
                        return;
                    }

                    populateGrids(restaurants);
                })
                .catch(error => {
                    isSearchInProgress = false;
                    showLoading(false);
                    showError('Error: ' + error.message);
                    console.error('Error:', error);
                });
        }

        // Allow Enter key to trigger search
        document.getElementById('latitude').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchRestaurants();
        });
        document.getElementById('longitude').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchRestaurants();
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(err => {
                    console.error('Service worker registration failed:', err);
                });
            });
        }
    </script>
</body>
</html>
