<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FCEDA5">
    <link rel="manifest" href="/manifest.json">
    <title>Savor Delicious Flavors of the Food Boulevard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Schematic placeholder style */
        .schematic-img {
            background-color: #e5e7eb;
            background-image: linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6), 
                              linear-gradient(45deg, #f3f4f6 25%, transparent 25%, transparent 75%, #f3f4f6 75%, #f3f4f6);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
        }

        .restaurant-box {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .restaurant-box:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .checkbox-pill {
            background: #e5e7eb;
            color: #374151;
        }

        .checkbox-pill.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .checkbox-pill:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex justify-center items-start">

    <!-- Main Container representing the board -->
    <div class="bg-white w-full max-w-[1400px] shadow-2xl overflow-hidden rounded-lg flex flex-col">
        
        <!-- Header -->
        <header class="bg-gray-100 p-6 border-b border-gray-300 flex justify-between items-center">
            <h1 class="text-2xl md:text-4xl font-extrabold text-gray-800 uppercase tracking-tight">
                Savor Delicious Flavors of the Food Boulevard
            </h1>
            <div class="hidden md:flex flex-col items-end text-sm text-gray-600">
                <span class="font-bold">READY TO EAT?</span>
                <span>SCAN AND GO!</span>
                <div class="w-12 h-12 bg-black mt-1"></div> <!-- QR Code Placeholder -->
            </div>
        </header>

        <!-- Search Section -->
        <div class="bg-white p-4 border-b border-gray-300">
            <div class="flex flex-col md:flex-row gap-3 mb-3">
                <input 
                    type="number" 
                    id="latitude" 
                    placeholder="Latitude (e.g., 40.7128)" 
                    step="any"
                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                >
                <input 
                    type="number" 
                    id="longitude" 
                    placeholder="Longitude (e.g., -74.0060)" 
                    step="any"
                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                >
            </div>

            <!-- Place Type Checkboxes -->
            <div class="mb-3">
                <span class="text-sm font-semibold text-gray-700 block mb-2">üìç Place Types:</span>
                <div class="flex flex-wrap gap-2" id="category-checkboxes">
                    <label class="checkbox-pill selected cursor-pointer px-3 py-1 rounded-full text-sm bg-purple-600 text-white transition-all" data-value="restaurant">
                        <input type="checkbox" value="restaurant" checked class="hidden"> üç¥ Restaurants
                    </label>
                    <label class="checkbox-pill selected cursor-pointer px-3 py-1 rounded-full text-sm bg-purple-600 text-white transition-all" data-value="cafe">
                        <input type="checkbox" value="cafe" checked class="hidden"> ‚òï Cafes
                    </label>
                    <label class="checkbox-pill selected cursor-pointer px-3 py-1 rounded-full text-sm bg-purple-600 text-white transition-all" data-value="bar">
                        <input type="checkbox" value="bar" checked class="hidden"> üç∫ Bars
                    </label>
                    <label class="checkbox-pill selected cursor-pointer px-3 py-1 rounded-full text-sm bg-purple-600 text-white transition-all" data-value="takeaway">
                        <input type="checkbox" value="takeaway" checked class="hidden"> üçî Fast Food
                    </label>
                    <label class="checkbox-pill selected cursor-pointer px-3 py-1 rounded-full text-sm bg-purple-600 text-white transition-all" data-value="bakery">
                        <input type="checkbox" value="bakery" checked class="hidden"> ü•ê Bakeries
                    </label>
                    <label class="checkbox-pill selected cursor-pointer px-3 py-1 rounded-full text-sm bg-purple-600 text-white transition-all" data-value="delivery">
                        <input type="checkbox" value="delivery" checked class="hidden"> üöó Delivery
                    </label>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-3">
                <select 
                    id="keyword"
                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none bg-white cursor-pointer"
                >
                    <option value="">üç≥ Any Cuisine</option>
                    <optgroup label="ü•ó Diet & Health">
                        <option value="healthy">Healthy Food</option>
                        <option value="vegan">Vegan</option>
                        <option value="vegetarian">Vegetarian</option>
                        <option value="organic">Organic</option>
                        <option value="gluten-free">Gluten-Free</option>
                        <option value="halal">Halal</option>
                        <option value="kosher">Kosher</option>
                    </optgroup>
                    <optgroup label="üåç World Cuisines">
                        <option value="italian">Italian</option>
                        <option value="chinese">Chinese</option>
                        <option value="japanese">Japanese</option>
                        <option value="sushi">Sushi</option>
                        <option value="mexican">Mexican</option>
                        <option value="indian">Indian</option>
                        <option value="thai">Thai</option>
                        <option value="vietnamese">Vietnamese</option>
                        <option value="korean">Korean</option>
                        <option value="french">French</option>
                        <option value="greek">Greek</option>
                        <option value="mediterranean">Mediterranean</option>
                        <option value="american">American</option>
                    </optgroup>
                    <optgroup label="üçï Popular Types">
                        <option value="pizza">Pizza</option>
                        <option value="burger">Burgers</option>
                        <option value="bbq">BBQ / Barbecue</option>
                        <option value="seafood">Seafood</option>
                        <option value="steakhouse">Steakhouse</option>
                        <option value="ramen">Ramen</option>
                        <option value="tacos">Tacos</option>
                        <option value="breakfast">Breakfast & Brunch</option>
                        <option value="dessert">Desserts & Ice Cream</option>
                    </optgroup>
                </select>
                <button 
                    id="search-btn"
                    onclick="searchRestaurants()" 
                    class="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors"
                >
                    üîç Search
                </button>
                <button 
                    id="location-btn"
                    onclick="getCurrentLocation()" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors"
                >
                    üìç My Location
                </button>
            </div>
            <div id="share-link" class="hidden mt-3 p-2 bg-gray-100 rounded-lg text-sm break-all">
                üìé Share: <a href="#" id="share-url" target="_blank" class="text-purple-600 hover:underline"></a>
            </div>
            <div id="error" class="hidden mt-3 bg-red-50 border-l-4 border-red-500 text-red-700 p-3 rounded"></div>
            <div id="loading" class="hidden mt-3 text-center">
                <div class="inline-block">
                    <div class="loading-spinner w-8 h-8 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Searching for restaurants...</p>
                </div>
            </div>
            <!-- Search Statistics -->
            <div id="stats-section" class="hidden mt-3 bg-gray-50 rounded-lg p-3 border border-gray-200">
                <div class="text-sm font-semibold text-gray-700 mb-2">üìä Search Statistics</div>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
                    <div id="stat-google-pages" class="bg-green-50 rounded p-2">
                        <div class="text-lg font-bold text-green-600">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Google Pages</div>
                    </div>
                    <div id="stat-google-queries" class="bg-green-50 rounded p-2">
                        <div class="text-lg font-bold text-green-600">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Queries</div>
                    </div>
                    <div id="stat-google-raw" class="bg-green-50 rounded p-2">
                        <div class="text-lg font-bold text-green-600">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Google Raw</div>
                    </div>
                    <div id="stat-osm" class="bg-blue-50 rounded p-2">
                        <div class="text-lg font-bold text-blue-600">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">OSM Results</div>
                    </div>
                    <div id="stat-before-dedup" class="bg-pink-50 rounded p-2">
                        <div class="text-lg font-bold text-pink-600">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Before Dedup</div>
                    </div>
                    <div id="stat-final" class="bg-purple-50 rounded p-2">
                        <div class="text-lg font-bold text-purple-600">0</div>
                        <div class="text-[10px] text-gray-500 uppercase">Final</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex flex-col h-full">
            
            <!-- MAIN COLUMN (Yellow) -->
            <div class="w-full bg-[#FCEDA5] flex flex-col relative" id="left-column">
                
                <!-- Floor 3 -->
                <div class="flex p-4" id="floor-3-left">
                    <div class="flex-1 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2" id="floor-3-left-grid">
                        <!-- Restaurants will be populated here -->
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div id="pagination-controls" class="hidden flex justify-center items-center gap-2 p-4 bg-[#FCEDA5] border-t border-yellow-300">
                    <button 
                        id="prev-page-btn"
                        onclick="goToPage(currentPage - 1)"
                        class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        ‚Üê Prev
                    </button>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-700">Page</span>
                        <select 
                            id="page-select"
                            onchange="goToPage(parseInt(this.value))"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none bg-white"
                        >
                        </select>
                        <span class="text-gray-700">of <span id="total-pages">1</span></span>
                    </div>
                    <button 
                        id="next-page-btn"
                        onclick="goToPage(currentPage + 1)"
                        class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Next ‚Üí
                    </button>
                    <span class="ml-4 text-sm text-gray-600">
                        (<span id="showing-count">0</span> of <span id="total-items">0</span> restaurants)
                    </span>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Floor grid configuration - only floor-3-left
        const floorGrids = [
            { id: 'floor-3-left-grid', cols: 6, isBlue: false }
        ];

        // Track request states to prevent multiple concurrent requests
        let isLocationRequestInProgress = false;
        let isSearchInProgress = false;
        let locationPermissionStatus = null; // 'granted', 'denied', 'prompt', or null

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 20; // Default items per page
        let currentSearchParams = null; // Store current search params for pagination

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            // Disable/enable buttons during loading
            const locationBtn = document.getElementById('location-btn');
            const searchBtn = document.getElementById('search-btn');
            
            [locationBtn, searchBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = show;
                    btn.style.opacity = show ? '0.6' : '1';
                    btn.style.cursor = show ? 'not-allowed' : 'pointer';
                }
            });
        }

        // Check and update permission status
        async function checkLocationPermission() {
            if (!navigator.permissions) {
                // Permissions API not supported, return unknown
                return null;
            }
            try {
                const result = await navigator.permissions.query({ name: 'geolocation' });
                locationPermissionStatus = result.state;
                
                // Listen for permission changes
                result.onchange = () => {
                    locationPermissionStatus = result.state;
                    updateLocationButtonState();
                };
                
                return result.state;
            } catch (e) {
                console.warn('Permission query failed:', e);
                return null;
            }
        }

        // Update button appearance based on permission state
        function updateLocationButtonState() {
            const locationBtn = document.getElementById('location-btn');
            if (!locationBtn) return;
            
            if (locationPermissionStatus === 'granted') {
                locationBtn.textContent = 'üìç My Location';
                locationBtn.title = 'Location access granted - click to get your position';
            } else if (locationPermissionStatus === 'denied') {
                locationBtn.textContent = 'üö´ Location Blocked';
                locationBtn.title = 'Location access denied - please enable it in browser settings';
            } else {
                locationBtn.textContent = 'üìç My Location';
                locationBtn.title = 'Click to request location access';
            }
        }

        // Get specific error message based on error code
        function getLocationErrorMessage(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    return 'üö´ Location access denied. Please enable location permissions in your browser settings and try again.';
                case error.POSITION_UNAVAILABLE:
                    return 'üì° Location unavailable. Your device could not determine your position. Please try again or enter coordinates manually.';
                case error.TIMEOUT:
                    return '‚è±Ô∏è Location request timed out. Please check your GPS/location settings and try again.';
                default:
                    return '‚ùå Unable to get your location: ' + error.message;
            }
        }

        async function getCurrentLocation() {
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser. Please enter coordinates manually.');
                return;
            }

            // Prevent multiple concurrent requests (debouncing)
            if (isLocationRequestInProgress) {
                console.log('Location request already in progress, ignoring duplicate request');
                return;
            }

            // Check permission status first
            const permissionState = await checkLocationPermission();
            
            // If permission was explicitly denied, show helpful message
            if (permissionState === 'denied') {
                showError('üö´ Location access is blocked. To enable it:\n‚Ä¢ Click the lock/info icon in your browser\'s address bar\n‚Ä¢ Find "Location" and set it to "Allow"\n‚Ä¢ Then refresh the page and try again');
                return;
            }

            // Set request in progress flag
            isLocationRequestInProgress = true;
            showLoading(true);

            // Geolocation options for better reliability
            const options = {
                enableHighAccuracy: true,  // Request high accuracy (GPS)
                timeout: 15000,            // 15 second timeout
                maximumAge: 60000          // Accept cached position up to 1 minute old
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Success callback
                    isLocationRequestInProgress = false;
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                    showLoading(false);
                    
                    // Update permission status
                    locationPermissionStatus = 'granted';
                    updateLocationButtonState();
                    
                    // Automatically search
                    searchRestaurants();
                },
                (error) => {
                    // Error callback
                    isLocationRequestInProgress = false;
                    showLoading(false);
                    
                    // Update permission status if denied
                    if (error.code === error.PERMISSION_DENIED) {
                        locationPermissionStatus = 'denied';
                        updateLocationButtonState();
                    }
                    
                    showError(getLocationErrorMessage(error));
                },
                options
            );
        }

        // Initialize permission check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkLocationPermission();
            updateLocationButtonState();
        });

        function formatDistance(distanceKm) {
            if (distanceKm < 1.0) {
                return Math.round(distanceKm * 1000) + 'm';
            }
            return distanceKm.toFixed(2) + 'km';
        }

        function displayStats(stats) {
            const statsSection = document.getElementById('stats-section');
            
            // Update stat values
            document.querySelector('#stat-google-pages div:first-child').textContent = stats.googlePagesSearched || 0;
            document.querySelector('#stat-google-queries div:first-child').textContent = stats.googleSearchQueries || 0;
            document.querySelector('#stat-google-raw div:first-child').textContent = stats.googleResultsRaw || 0;
            document.querySelector('#stat-osm div:first-child').textContent = stats.osmResultsTotal || 0;
            document.querySelector('#stat-before-dedup div:first-child').textContent = stats.totalBeforeDedup || 0;
            document.querySelector('#stat-final div:first-child').textContent = stats.totalAfterDedup || 0;

            // Show/hide relevant stats based on what data is available
            const hasGoogle = (stats.googlePagesSearched || 0) > 0 || (stats.googleResultsRaw || 0) > 0;
            const hasOSM = (stats.osmResultsTotal || 0) > 0;

            // Show Google stats if we have Google data
            document.getElementById('stat-google-pages').style.display = hasGoogle ? 'block' : 'none';
            document.getElementById('stat-google-queries').style.display = hasGoogle ? 'block' : 'none';
            document.getElementById('stat-google-raw').style.display = hasGoogle ? 'block' : 'none';
            
            // Show OSM stats if we have OSM data
            document.getElementById('stat-osm').style.display = hasOSM ? 'block' : 'none';

            // Show the stats section
            statsSection.classList.remove('hidden');
        }

        // Setup checkbox toggle behavior
        document.querySelectorAll('.checkbox-pill').forEach(item => {
            item.addEventListener('click', function(e) {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                this.classList.toggle('selected', checkbox.checked);
            });
        });

        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('#category-checkboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function setSelectedCategories(categories) {
            document.querySelectorAll('#category-checkboxes .checkbox-pill').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const isSelected = categories.includes(checkbox.value);
                checkbox.checked = isSelected;
                item.classList.toggle('selected', isSelected);
            });
        }

        function updateURL(lat, lon, categories, keyword, page = 1) {
            const url = new URL(window.location.href);
            url.searchParams.set('lat', lat);
            url.searchParams.set('lon', lon);
            url.searchParams.set('categories', categories.join(','));
            if (keyword) {
                url.searchParams.set('keyword', keyword);
            } else {
                url.searchParams.delete('keyword');
            }
            if (page > 1) {
                url.searchParams.set('page', page);
            } else {
                url.searchParams.delete('page');
            }
            window.history.pushState({}, '', url);
            
            // Show share link
            const shareLink = document.getElementById('share-link');
            const shareUrl = document.getElementById('share-url');
            shareUrl.href = url.toString();
            shareUrl.textContent = url.toString();
            shareLink.classList.remove('hidden');
        }

        function parseURLParams() {
            const params = new URLSearchParams(window.location.search);
            const lat = params.get('lat');
            const lon = params.get('lon');
            const categories = params.get('categories');
            const keyword = params.get('keyword');
            const page = params.get('page');
            
            // Legacy support
            const legacyCategory = params.get('category');
            
            if (lat && lon) {
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lon;
                
                if (categories) {
                    setSelectedCategories(categories.split(','));
                } else if (legacyCategory && legacyCategory !== 'all') {
                    setSelectedCategories([legacyCategory]);
                }
                
                if (keyword) {
                    document.getElementById('keyword').value = keyword;
                }
                
                // Set initial page from URL
                if (page && parseInt(page) > 0) {
                    currentPage = parseInt(page);
                }
                
                return true;
            }
            return false;
        }

        function getRestaurantImageUrl(restaurant) {
            // Photos are stored by place_id (stable restaurant identifier)
            // This ensures we never call the API twice for the same restaurant
            if (restaurant.PlaceID && restaurant.PhotoReference) {
                return `/api/photo?place_id=${encodeURIComponent(restaurant.PlaceID)}&photo_reference=${encodeURIComponent(restaurant.PhotoReference)}`;
            }
            
            // If we have PlaceID but no photo reference (or GENERIC), still use the endpoint
            // This will serve the generic placeholder image
            if (restaurant.PlaceID) {
                return `/api/photo?place_id=${encodeURIComponent(restaurant.PlaceID)}&photo_reference=`;
            }
            
            // Fallback for restaurants without PlaceID (e.g., OSM results)
            // Try to get a food-related image from Unsplash Source
            const hash = restaurant.Name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const foodKeywords = ['restaurant', 'food', 'dining', 'cuisine', 'meal', 'dish', 'cooking'];
            const keyword = foodKeywords[hash % foodKeywords.length];
            // Use Unsplash Source with a unique identifier based on restaurant name
            return `https://source.unsplash.com/400x300/?${keyword}&sig=${hash}`;
        }

        function getRestaurantBackgroundColor(restaurant) {
            // Generate a color gradient based on restaurant name as fallback
            const hash = restaurant.Name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const hue1 = hash % 360;
            const hue2 = (hash + 60) % 360;
            return `linear-gradient(135deg, hsl(${hue1}, 70%, 50%) 0%, hsl(${hue2}, 70%, 50%) 100%)`;
        }

        function formatPriceLevel(priceLevel) {
            if (priceLevel === undefined || priceLevel === null) {
                return '';
            }
            switch (priceLevel) {
                case 0:
                    return 'Average bill: Free';
                case 1:
                    return 'Average bill: $ (Inexpensive)';
                case 2:
                    return 'Average bill: $$ (Moderate)';
                case 3:
                    return 'Average bill: $$$ (Expensive)';
                case 4:
                    return 'Average bill: $$$$ (Very Expensive)';
                default:
                    return '';
            }
        }

        function getPriceSymbol(priceLevel) {
            if (priceLevel === undefined || priceLevel === null) {
                return '';
            }
            switch (priceLevel) {
                case 0:
                    return 'Free';
                case 1:
                    return '$';
                case 2:
                    return '$$';
                case 3:
                    return '$$$';
                case 4:
                    return '$$$$';
                default:
                    return '';
            }
        }

        function createRestaurantBox(restaurant, index, isBlue = false, isRed = false) {
            const box = document.createElement('div');
            // Make cards bigger - taller aspect ratio
            box.className = 'restaurant-box flex flex-col gap-2 w-full aspect-[3/4] md:aspect-[4/3]';
            
            // Use place_id if available (opens actual restaurant page), otherwise use coordinates
            let mapsURL;
            if (restaurant.PlaceID) {
                // Use query+query_place_id to open the Google Place card directly
                const nameParam = encodeURIComponent(restaurant.Name || 'GooglePlace');
                mapsURL = `https://www.google.com/maps/search/?api=1&query=${nameParam}&query_place_id=${restaurant.PlaceID}`;
            } else {
                const searchQuery = encodeURIComponent(`${restaurant.Name || 'Restaurant'} ${restaurant.Latitude},${restaurant.Longitude}`);
                mapsURL = `https://www.google.com/maps/search/?api=1&query=${searchQuery}`;
            }
            
            // Add image - make it bigger
            const imgContainer = document.createElement('div');
            const bgGradient = getRestaurantBackgroundColor(restaurant);
            imgContainer.className = 'w-full h-[75%] md:h-[70%] rounded-sm border border-black/5 relative overflow-hidden';
            imgContainer.style.background = bgGradient;
            imgContainer.style.backgroundSize = 'cover';
            imgContainer.style.backgroundPosition = 'center';
            
            const img = document.createElement('img');
            img.className = 'w-full h-full object-cover absolute top-0 left-0';
            img.alt = restaurant.Name;
            
            // Create photo source badge (initially hidden)
            const photoSourceBadge = document.createElement('div');
            photoSourceBadge.className = 'absolute top-8 left-2 text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded hidden';
            imgContainer.appendChild(photoSourceBadge);
            
            // Fetch image to get the X-Photo-Source header
            const imageUrl = getRestaurantImageUrl(restaurant);
            if (imageUrl.startsWith('/api/photo')) {
                // Fetch from our API to get headers
                fetch(imageUrl)
                    .then(response => {
                        const photoSource = response.headers.get('X-Photo-Source');
                        return response.blob().then(blob => ({ blob, photoSource }));
                    })
                    .then(({ blob, photoSource }) => {
                        img.src = URL.createObjectURL(blob);
                        img.style.display = 'block';
                        
                        // Show photo source indicator
                        if (photoSource) {
                            photoSourceBadge.classList.remove('hidden');
                            switch (photoSource) {
                                case 'disk':
                                    photoSourceBadge.textContent = 'üíæ Disk';
                                    photoSourceBadge.className = 'absolute top-8 left-2 bg-green-500/80 text-white text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                                    photoSourceBadge.title = 'Photo loaded from disk cache (free)';
                                    break;
                                case 'api':
                                    photoSourceBadge.textContent = 'üåê API';
                                    photoSourceBadge.className = 'absolute top-8 left-2 bg-blue-500/80 text-white text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                                    photoSourceBadge.title = 'Photo fetched from Google API ($0.007)';
                                    break;
                                case 'generic':
                                    photoSourceBadge.textContent = 'üñºÔ∏è Generic';
                                    photoSourceBadge.className = 'absolute top-8 left-2 bg-gray-500/80 text-white text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                                    photoSourceBadge.title = 'Generic placeholder image (no API call)';
                                    break;
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Failed to load image:', err);
                        img.style.display = 'none';
                    });
            } else {
                // External URL (Unsplash fallback)
                img.src = imageUrl;
                img.onerror = function() {
                    this.style.display = 'none';
                };
                img.onload = function() {
                    this.style.display = 'block';
                };
            }
            imgContainer.appendChild(img);
            
            // Add rating badge if available (same size as price badge)
            if (restaurant.Rating > 0) {
                const ratingBadge = document.createElement('div');
                ratingBadge.className = 'absolute top-2 left-2 bg-black/50 text-white text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                let ratingText = `‚≠ê${restaurant.Rating.toFixed(1)}`;
                if (restaurant.ReviewCount && restaurant.ReviewCount > 0) {
                    ratingText += `(${restaurant.ReviewCount})`;
                }
                ratingBadge.textContent = ratingText;
                imgContainer.appendChild(ratingBadge);
            }

            const priceSymbol = getPriceSymbol(restaurant.PriceLevel);
            if (priceSymbol) {
                const priceBadge = document.createElement('div');
                priceBadge.className = 'absolute top-2 right-2 bg-black/50 text-green-300 text-[10px] md:text-[8px] font-semibold px-1.5 py-0.5 rounded';
                priceBadge.textContent = priceSymbol;
                const priceDescription = formatPriceLevel(restaurant.PriceLevel);
                if (priceDescription) {
                    priceBadge.title = priceDescription;
                }
                imgContainer.appendChild(priceBadge);
            }
            
            box.appendChild(imgContainer);

            // Add text label - full name on mobile, truncated on desktop
            const textLabel = document.createElement('div');
            textLabel.textContent = restaurant.Name;
            textLabel.className = 'text-sm md:text-[9px] font-bold leading-tight text-center px-1 md:truncate';
            
            if (isRed) {
                textLabel.classList.add('text-red-600');
            } else if (isBlue) {
                textLabel.classList.add('text-white');
            } else {
                textLabel.classList.add('text-gray-800');
            }
            
            box.appendChild(textLabel);

            if (restaurant.Type) {
                const typeBadge = document.createElement('div');
                typeBadge.textContent = restaurant.Type;
                typeBadge.className = 'absolute bottom-2 left-2 bg-white/70 text-gray-700 text-[10px] md:text-[8px] px-2 py-0.5 rounded';
                imgContainer.appendChild(typeBadge);
            }

            const distanceLabel = document.createElement('div');
            distanceLabel.textContent = formatDistance(restaurant.Distance);
            distanceLabel.className = 'absolute bottom-2 right-2 bg-black/50 text-white text-[10px] md:text-[8px] px-2 py-0.5 rounded';
            imgContainer.appendChild(distanceLabel);

            // Add click handler to open maps
            box.onclick = () => window.open(mapsURL, '_blank');
            box.title = `${restaurant.Name}\n${restaurant.Address || 'No address'}\nDistance: ${formatDistance(restaurant.Distance)}`;

            return box;
        }

        function clearAllGrids() {
            const element = document.getElementById('floor-3-left-grid');
            if (element) {
                element.innerHTML = '';
            }
        }

        function populateGrids(restaurants) {
            clearAllGrids();
            
            // Put all restaurants in floor-3-left-grid
            const element = document.getElementById('floor-3-left-grid');
            if (!element) return;
            
            // Calculate offset based on current page
            const indexOffset = (currentPage - 1) * itemsPerPage;
            
            restaurants.forEach((restaurant, index) => {
                const box = createRestaurantBox(
                    restaurant, 
                    index + indexOffset, // Add offset for correct numbering
                    false, // isBlue
                    false  // isRed
                );
                element.appendChild(box);
            });
        }

        function searchRestaurants(page = 1, isNewSearch = true) {
            // Prevent multiple concurrent search requests
            if (isSearchInProgress) {
                console.log('Search already in progress, ignoring duplicate request');
                return;
            }

            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const categories = getSelectedCategories();
            const keyword = document.getElementById('keyword').value;

            if (isNaN(lat) || isNaN(lon)) {
                showError('Please enter valid latitude and longitude values');
                return;
            }

            if (categories.length === 0) {
                showError('Please select at least one place type');
                return;
            }

            // Reset to page 1 for new searches
            if (isNewSearch) {
                currentPage = 1;
                page = 1;
            }

            // Store search params for pagination
            currentSearchParams = { lat, lon, categories, keyword };

            // Update URL for sharing
            updateURL(lat, lon, categories, keyword, page);

            isSearchInProgress = true;
            showLoading(true);
            clearAllGrids();
            document.getElementById('stats-section').classList.add('hidden');
            document.getElementById('pagination-controls').classList.add('hidden');

            // Build query URL with pagination
            let url = `/api/restaurants?lat=${lat}&lon=${lon}&categories=${categories.join(',')}&page=${page}&limit=${itemsPerPage}`;
            if (keyword) {
                url += `&keyword=${encodeURIComponent(keyword)}`;
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'Failed to fetch restaurants');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    isSearchInProgress = false;
                    showLoading(false);
                    
                    // Handle both old format (array) and new format (object with stats)
                    const restaurants = data.restaurants || data;
                    const stats = data.stats || null;
                    const pagination = data.pagination || null;

                    // Display stats if available
                    if (stats) {
                        displayStats(stats);
                    }

                    // Update pagination controls
                    if (pagination) {
                        updatePaginationControls(pagination);
                    }

                    if (restaurants.length === 0 && page === 1) {
                        showError('No restaurants found. Try a different location.');
                        return;
                    }

                    populateGrids(restaurants);
                })
                .catch(error => {
                    isSearchInProgress = false;
                    showLoading(false);
                    showError('Error: ' + error.message);
                    console.error('Error:', error);
                });
        }

        function updatePaginationControls(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.totalPages;

            const paginationControls = document.getElementById('pagination-controls');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            const pageSelect = document.getElementById('page-select');
            const totalPagesSpan = document.getElementById('total-pages');
            const showingCount = document.getElementById('showing-count');
            const totalItems = document.getElementById('total-items');

            // Show pagination controls if there's more than one page
            if (pagination.totalPages > 1) {
                paginationControls.classList.remove('hidden');
            } else {
                paginationControls.classList.add('hidden');
            }

            // Update prev/next button states
            prevBtn.disabled = !pagination.hasPrev;
            nextBtn.disabled = !pagination.hasNext;

            // Update page selector
            pageSelect.innerHTML = '';
            for (let i = 1; i <= pagination.totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === pagination.page) {
                    option.selected = true;
                }
                pageSelect.appendChild(option);
            }

            // Update text
            totalPagesSpan.textContent = pagination.totalPages;
            
            // Calculate showing range
            const startItem = (pagination.page - 1) * pagination.limit + 1;
            const endItem = Math.min(pagination.page * pagination.limit, pagination.totalItems);
            showingCount.textContent = `${startItem}-${endItem}`;
            totalItems.textContent = pagination.totalItems;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) {
                return;
            }
            currentPage = page;
            searchRestaurants(page, false);
        }

        // Allow Enter key to trigger search
        document.getElementById('latitude').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchRestaurants();
        });
        document.getElementById('longitude').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchRestaurants();
        });

        // Parse URL params on page load and auto-search if present
        window.addEventListener('DOMContentLoaded', () => {
            if (parseURLParams()) {
                // Use the page from URL (set by parseURLParams) or default to 1
                searchRestaurants(currentPage, false);
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').catch(err => {
                    console.error('Service worker registration failed:', err);
                });
            });
        }
    </script>
</body>
</html>
